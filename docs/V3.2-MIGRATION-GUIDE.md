# v3.2 Migration Guide - Multi-League Support

## Overview

Sports Platform v3.2 introduces **multi-league support** while maintaining the strict 3-tool limit for optimal LLM performance. Users can now access multiple fantasy leagues per sport/provider through a clean league_id parameter system.

## Key Changes from v3.1

### 1. League ID Parameter (Required)
```javascript
// v3.1 (Old)
{
  "name": "mlb.fantasy",
  "parameters": {
    "provider": "espn",
    "endpoint": "team_roster"
  }
}

// v3.2 (New)
{
  "name": "mlb.fantasy", 
  "parameters": {
    "provider": "espn",
    "league_id": "12345",  // ← NEW REQUIRED PARAMETER
    "endpoint": "team_roster"
  }
}
```

### 2. League Discovery API
```bash
# New endpoint for discovering user leagues
GET /leagues?sport=baseball&provider=espn&uid=user123

# Response
{
  "sport": "baseball",
  "provider": "espn", 
  "leagues": [
    {
      "id": "12345",
      "name": "My Fantasy League",
      "provider": "espn",
      "sport": "baseball",
      "teams": 12
    }
  ]
}
```

### 3. Per-League Authentication Storage
```javascript
// v3.1: Global provider auth
Key: "user123:baseball:espn"
Value: { espn_s2: "...", swid: "..." }

// v3.2: Per-league granular auth  
Key: "user123:baseball:espn:12345"
Value: { espn_s2: "...", swid: "...", league_id: "12345" }
```

### 4. League-Aware LLM Prompts
```javascript
// With league selected
"For fantasy questions: Use mlb.fantasy with provider='espn' and league_id='12345'"

// Without league selected  
"IMPORTANT: You must include 'league_id' parameter. Ask: 'Which league?'"
```

## Migration Steps

### For Frontend Developers

1. **Add League Selection UI**
   ```javascript
   // 1. Fetch user's leagues
   const leagues = await fetch('/leagues?sport=baseball&provider=espn&uid=user123');
   
   // 2. Present league picker UI
   <select onChange={handleLeagueSelect}>
     {leagues.map(league => 
       <option value={league.id}>{league.name}</option>
     )}
   </select>
   
   // 3. Include leagueId in API calls
   const response = await fetch('/responses', {
     body: JSON.stringify({
       model: 'gpt-4',
       input: 'Get my roster',
       userId: 'user123',
       sport: 'mlb', 
       fantasyProvider: 'espn',
       leagueId: selectedLeagueId  // ← Include in all fantasy requests
     })
   });
   ```

2. **Handle Missing League ID**
   ```javascript
   // Auto-prompt for league selection
   if (response.error?.includes('league_id')) {
     showLeaguePicker();
   }
   ```

### For API Consumers

1. **Update Tool Calls**
   ```javascript
   // Before v3.2
   {
     "name": "mlb.fantasy",
     "arguments": {
       "provider": "espn",
       "endpoint": "team_roster"
     }
   }
   
   // After v3.2
   {
     "name": "mlb.fantasy",
     "arguments": {
       "provider": "espn", 
       "league_id": "12345",  // ← Always include
       "endpoint": "team_roster"
     }
   }
   ```

2. **League Discovery Workflow**
   ```javascript
   // 1. Get available leagues
   const leagues = await discoverLeagues(sport, provider, userId);
   
   // 2. Store user's league preference
   const selectedLeague = await promptUserForLeague(leagues);
   
   // 3. Use in all subsequent fantasy calls
   await callFantasyTool(provider, selectedLeague.id, endpoint);
   ```

## Provider-Specific Notes

### ESPN Authentication
- Uses cookie-based authentication (swid + espn_s2)
- Cookies are shared across leagues but stored per-league for granular control
- Rate limited at ~200 requests/minute per account

### Yahoo Authentication  
- Uses OAuth 2.0 with refresh tokens
- Tokens expire every hour (auto-refresh implemented)
- Each league requires separate OAuth scope approval

## Error Handling

### Common Errors

```javascript
// Missing league_id
{
  "error": "Missing league_id parameter - required for v3.2",
  "help": "Use /leagues endpoint to discover available leagues"
}

// Invalid league_id
{
  "error": "League 99999 not found or access denied", 
  "provider": "espn",
  "available_leagues": "/leagues?sport=baseball&provider=espn&uid=user123"
}

// Authentication required
{
  "error": "ESPN authentication required to discover leagues",
  "login_required": true,
  "provider": "espn"
}
```

### Error Recovery
```javascript
async function handleFantasyError(error, sport, provider, userId) {
  if (error.includes('league_id')) {
    // Show league picker
    const leagues = await fetch(`/leagues?sport=${sport}&provider=${provider}&uid=${userId}`);
    return showLeaguePicker(leagues);
  }
  
  if (error.includes('authentication required')) {
    // Redirect to provider login
    return redirectToAuth(provider);
  }
  
  if (error.includes('not found')) {
    // Refresh league list
    return refreshLeagues(sport, provider, userId);
  }
}
```

## Testing v3.2 Features

### Manual Testing
```bash
# Test league discovery
curl "https://sports-proxy.workers.dev/leagues?sport=baseball&provider=espn&uid=test-user"

# Test fantasy call with league_id
curl -X POST https://sports-proxy.workers.dev/responses \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-4",
    "input": "Get my fantasy roster",
    "userId": "test-user",
    "sport": "mlb", 
    "fantasyProvider": "espn",
    "leagueId": "12345"
  }'

# Test missing league_id (should fail)
curl -X POST https://sports-proxy.workers.dev/mcp/call \
  -d '{"name": "mlb.fantasy", "arguments": {"provider": "espn", "endpoint": "team_roster"}}'
```

### Automated Testing
```bash
# Run v3.2 regression tests
node test-v3.2-regression.js

# Run updated CI guards
node ci-guards.js
```

## Performance Impact

### Token Usage
- **League ID parameter**: +10 tokens per fantasy request
- **Auto-fill logic**: Reduces redundant parameter passing
- **League discovery**: Cached for 5 minutes to minimize API calls

### Storage Impact
- **Per-league keys**: More granular storage, better security
- **Backward compatibility**: Global keys still supported for single-league users
- **Cache efficiency**: League-specific caching improves hit rates

## Backward Compatibility

### v3.1 Support
- Global provider authentication still works for single-league setups
- Auto-fill logic provides league_id when missing (if only one league)
- Gradual migration supported - no breaking changes for existing integrations

### Migration Timeline
1. **Phase 1**: Deploy v3.2 with league_id optional (auto-filled from session)
2. **Phase 2**: Update frontend UIs to include league picker
3. **Phase 3**: Make league_id required (current state)
4. **Phase 4**: Remove auto-fill logic once all clients updated

## Summary

v3.2 enables unlimited league access through a clean parameter-based architecture:

- ✅ **Same 3-tool limit** maintained for optimal LLM performance
- ✅ **Zero context-window penalty** through parameter approach vs separate tools
- ✅ **Granular authentication** with per-league credential isolation  
- ✅ **League-aware prompts** guide users through league selection
- ✅ **Comprehensive testing** ensures production readiness
- ✅ **Backward compatibility** supports gradual migration

The architecture scales to unlimited leagues while maintaining the proven v3.1 performance characteristics.